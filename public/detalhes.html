    <!DOCTYPE html>
    <html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Detalhes do Pedido</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="css/style.css">
    </head>
    <body>
        <div class="container mt-5">
            <form id="formDetalhesPedido">
                
                <div class="row g-3 containerJ">
                    <div class="col-12">
                        <h1>Detalhes do Pedido</h1>
                    </div>
                    <div class="col-2">
                        <label for="codigo" class="form-label">Código do Pedido</label>
                        <input type="text" id="codigo" class="form-control" disabled>
                    </div>
                    <div class="col-7">
                        <label for="cliente" class="form-label">Cliente</label>
                        <input type="text" id="cliente" class="form-control" disabled>
                    </div>
                    <div class="col-3">
                        <label for="telefone" class="form-label">Telefone</label>
                        <input type="text" id="telefone" class="form-control" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="endereco" class="form-label">Endereço</label>
                        <input type="text" id="endereco" class="form-control" disabled>
                    </div>
                    <div class="col-6">
                        <label for="envio" class="form-label">Método de entrega</label>
                        <select id="envio" class="form-select">
                            <option value="envio">Enviar para Cliente</option>
                            <option value="retirada">Retirada em Loja</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label for="status" class="form-label">Status</label>
                        <select id="status" class="form-select">
                            <option value="feito">Feito</option>
                            <option value="em preparação">Em Preparação</option>
                            <option value="finalizado">Finalizado</option>
                            <option value="enviado">Enviado</option>
                            <option value="concluído">Concluído</option>
                        </select>
                    </div>
                    <div class="col">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea id="observacoes" class="form-control"></textarea>
                    </div>
                </div>
                <div class="row containerJ mt-4">
                    <div class="col">
                        <h3 class="mt-4">Produtos</h3>
                        <div id="produtosContainer"></div>
                        <button type="button" id="adicionarProduto" class="btn btn-secondary mt-3">Adicionar Produto</button>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col">
                        <button type="button" class="btn btn-danger" onclick="window.history.back()"><i class="bi bi-arrow-left"></i> Voltar</button>
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    </div>
                </div>
            </form>
        </div>

        <script>
             const params = new URLSearchParams(window.location.search);
        const pedidoId = params.get('pedido_id'); // `pedido_id` será recebido como parâmetro na URL

        async function carregarDetalhesPedido() {
            if (!pedidoId) {
                alert('ID do pedido não fornecido!');
                window.history.back();
                return;
            }

            try {
                const response = await fetch(`/pedidos/${pedidoId}`);
                if (!response.ok) throw new Error('Erro ao buscar o pedido.');

                const pedido = await response.json();
                document.getElementById('codigo').value = pedido.codigo;
                document.getElementById('cliente').value = pedido.cliente_nome || '';
                document.getElementById('envio').value = pedido.envio || 'retirar';
                document.getElementById('status').value = pedido.status || 'feito';
                document.getElementById('observacoes').value = pedido.observacoes || '';

                carregarProdutos(pedido.id);
            } catch (err) {
                console.error('Erro ao carregar os detalhes do pedido:', err.message);
                alert('Erro ao carregar os detalhes do pedido.');
                window.history.back();
            }
        }

        async function carregarProdutos(pedidoId) {
            try {
                const response = await fetch(`/produtos_pedido?pedido_id=${pedidoId}`);
                if (!response.ok) throw new Error('Erro ao buscar produtos.');

                const produtos = await response.json();
                const produtosContainer = document.getElementById('produtosContainer');
                produtosContainer.innerHTML = '';

                produtos.forEach(produto => {
                    const produtoDiv = document.createElement('div');
                    produtoDiv.classList.add('mb-3', 'produto-item');
                    produtoDiv.innerHTML = `
                        <label class="form-label">Produto</label>
                        <input type="text" class="form-control mb-2 produto-nome" value="${produto.produto}" placeholder="Nome do Produto">
                        <label class="form-label">Detalhes</label>
                        <textarea class="form-control produto-detalhes">${produto.detalhes}</textarea>
                        <button type="button" class="btn btn-danger mt-2 btn-remover-produto">Remover Produto</button>
                    `;

                    produtoDiv.querySelector('.btn-remover-produto').addEventListener('click', () => {
                        produtoDiv.remove();
                    });

                    produtosContainer.appendChild(produtoDiv);
                });
            } catch (err) {
                console.error('Erro ao carregar produtos:', err.message);
            }
        }

        document.getElementById('adicionarProduto').addEventListener('click', () => {
            const produtosContainer = document.getElementById('produtosContainer');
            const produtoDiv = document.createElement('div');
            produtoDiv.classList.add('mb-3', 'produto-item');
            produtoDiv.innerHTML = `
                <label class="form-label">Produto</label>
                <input type="text" class="form-control mb-2 produto-nome" placeholder="Nome do Produto">
                <label class="form-label">Detalhes</label>
                <textarea class="form-control produto-detalhes" placeholder="Ex.: Sabor, Tamanho"></textarea>
                <button type="button" class="btn btn-danger mt-2 btn-remover-produto">Remover Produto</button>
            `;

            produtoDiv.querySelector('.btn-remover-produto').addEventListener('click', () => {
                produtoDiv.remove();
            });

            produtosContainer.appendChild(produtoDiv);
        });

        document.getElementById('formDetalhesPedido').addEventListener('submit', async (e) => {
            e.preventDefault();

            const envio = document.getElementById('envio').value;
            const status = document.getElementById('status').value;
            const observacoes = document.getElementById('observacoes').value;

            const produtos = Array.from(document.querySelectorAll('.produto-item')).map(item => ({
                produto: item.querySelector('.produto-nome').value,
                detalhes: item.querySelector('.produto-detalhes').value
            }));

            try {
                await fetch(`/pedidos/${pedidoId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ envio, status, observacoes, produtos }),
                });

                alert('Pedido atualizado com sucesso!');
            } catch (err) {
                console.error('Erro ao salvar alterações:', err.message);
                alert('Erro ao salvar alterações.');
            }
        });
        

        carregarDetalhesPedido();
        </script>
    </body>
    </html>
