<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro e Edição de Clientes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Cadastro de Clientes</h1>
        <form id="formCliente" class="mb-4">
            <div class="mb-3">
                <label for="nome" class="form-label">Nome</label>
                <input type="text" id="nome" name="nome" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="telefone" class="form-label">Telefone</label>
                <input type="text" id="telefone" name="telefone" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="endereco" class="form-label">Endereço</label>
                <input type="text" id="endereco" name="endereco" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Cadastrar Cliente</button>
        </form>

        <h2>Lista de Clientes</h2>
        <ul id="listaClientes" class="list-group mb-4"></ul>
        <div id="paginacao" class="d-flex justify-content-center my-3"></div>

    </div>

    <!-- Modal para Edição -->
    <div class="modal fade" id="modalEdicao" tabindex="-1" aria-labelledby="modalEdicaoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEdicaoLabel">Editar Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formEdicao">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label for="editNome" class="form-label">Nome</label>
                            <input type="text" id="editNome" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editTelefone" class="form-label">Telefone</label>
                            <input type="text" id="editTelefone" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEndereco" class="form-label">Endereço</label>
                            <input type="text" id="editEndereco" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Salvar Alterações</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let clientes = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        document.getElementById('formCliente').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nome = document.getElementById('nome').value;
            const telefone = document.getElementById('telefone').value;
            const endereco = document.getElementById('endereco').value;

            const response = await fetch('/clientes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nome, telefone, endereco }),
            });

            const data = await response.json();
            if (response.ok) {
                alert('Cliente cadastrado com sucesso!');
                carregarClientes();
                document.getElementById('formCliente').reset();
            } else {
                alert(data.errors?.map(err => err.msg).join('\n') || data.error);
            }
        });

        async function carregarClientes() {
            const response = await fetch('/clientes');
            clientes = await response.json();
            exibirClientes();
        }

        function atualizarPaginacao(totalPaginas, paginaAtual) {
            const paginacao = document.getElementById('paginacao');
            paginacao.innerHTML = '';

            for (let i = 1; i <= totalPaginas; i++) {
                const btnPagina = document.createElement('button');
                btnPagina.textContent = i;
                btnPagina.classList.add('btn', 'btn-outline-primary', 'me-2');

                // Adiciona a classe 'active' apenas para a página atual
                if (i === paginaAtual) {
                    btnPagina.classList.add('active');
                }

                btnPagina.addEventListener('click', () => {
                    exibirClientes(i);
                });

                paginacao.appendChild(btnPagina);
            }
        }

        async function exibirClientes(pagina = 1) {
            const clientesPorPagina = 10;

            const inicio = (pagina - 1) * clientesPorPagina;
            const fim = inicio + clientesPorPagina;

            const listaClientes = document.getElementById('listaClientes');
            listaClientes.innerHTML = '';

            const response = await fetch('/clientes');
            const clientes = await response.json();

            const totalPaginas = Math.ceil(clientes.length / clientesPorPagina);

            const clientesPagina = clientes.slice(inicio, fim);
            clientesPagina.forEach(cliente => {
                const li = document.createElement('li');
                li.textContent = `${cliente.nome} - ${cliente.telefone} - ${cliente.endereco}`;
                li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');

                const btnEditar = document.createElement('button');
                btnEditar.textContent = 'Editar';
                btnEditar.classList.add('btn', 'btn-sm', 'btn-warning', 'me-2');
                btnEditar.addEventListener('click', () => abrirModalEdicao(cliente));

                const btnExcluir = document.createElement('button');
                btnExcluir.textContent = 'Excluir';
                btnExcluir.classList.add('btn', 'btn-sm', 'btn-danger');
                btnExcluir.addEventListener('click', () => excluirCliente(cliente.id));

                li.appendChild(btnEditar);
                li.appendChild(btnExcluir);
                listaClientes.appendChild(li);
            });

            atualizarPaginacao(totalPaginas, pagina);
        }

        
        function mudarPagina(page) {
            currentPage = page;
            exibirClientes();
        }

        async function excluirCliente(id) {
            if (!confirm('Tem certeza que deseja excluir este cliente?')) return;

            const response = await fetch(`/clientes/${id}`, { method: 'DELETE' });
            const result = await response.json();
            if (response.ok) {
                alert(result.message);
                carregarClientes();
            } else {
                alert(result.error);
            }
        }

        function abrirModalEdicao(cliente) {
    // Preenche os campos do modal com os dados do cliente
    document.getElementById('editNome').value = cliente.nome;
    document.getElementById('editTelefone').value = cliente.telefone;
    document.getElementById('editEndereco').value = cliente.endereco;

    // Configura o evento de envio do formulário de edição
    const formEdicao = document.getElementById('formEdicao');
    formEdicao.onsubmit = async (e) => {
        e.preventDefault();

        const updatedNome = document.getElementById('editNome').value;
        const updatedTelefone = document.getElementById('editTelefone').value;
        const updatedEndereco = document.getElementById('editEndereco').value;

        const response = await fetch(`/clientes/${cliente.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                nome: updatedNome,
                telefone: updatedTelefone,
                endereco: updatedEndereco,
            }),
        });

        if (response.ok) {
            alert('Cliente atualizado com sucesso!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalEdicao'));
            modal.hide();
            exibirClientes(); // Atualiza a lista de clientes
        } else {
            alert('Erro ao atualizar cliente. Tente novamente.');
        }
    };

    // Exibe o modal
    const modal = new bootstrap.Modal(document.getElementById('modalEdicao'));
    modal.show();
}


        document.getElementById('formEdicao').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editId').value;
            const nome = document.getElementById('editNome').value;
            const telefone = document.getElementById('editTelefone').value;
            const endereco = document.getElementById('editEndereco').value;

            const response = await fetch(`/clientes/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nome, telefone, endereco }),
            });

            const result = await response.json();
            if (response.ok) {
                alert(result.message);
                carregarClientes();
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalEdicao'));
                modal.hide();
            } else {
                alert(result.error);
            }
        });

        carregarClientes();
    </script>
</body>
</html>
